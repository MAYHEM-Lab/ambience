project(tos C CXX ASM)

add_library(aarch64_core core.cpp)
target_include_directories(aarch64_core PUBLIC include)
target_compile_features(aarch64_core PUBLIC cxx_std_17)
target_link_libraries(aarch64_core PUBLIC cmsis::core)
target_compile_definitions(aarch64_core PUBLIC __PROGRAM_START=_start)

add_library(aarch64_impl impl.cpp boot.S newlib_stubs.cpp)
target_include_directories(aarch64_impl PUBLIC include)
target_link_libraries(aarch64_impl PUBLIC aarch64_core tos_ft)
target_link_libraries(aarch64_impl PUBLIC "-T${CMAKE_CURRENT_SOURCE_DIR}/linker.ld")
target_link_options(aarch64_impl PUBLIC -ffreestanding -nostdlib)
target_link_libraries(aarch64_impl PUBLIC "-Wl,--start-group -lgcc -lm -lc -lg -lstdc++ -lsupc++ -Wl,--end-group -Wl,--undefined=_read -Wl,--undefined=memset")
set_target_properties(aarch64_impl PROPERTIES LINK_DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/linker.ld)